function $(sel,ctx=document){return ctx.querySelector(sel)}
function $$(sel,ctx=document){return Array.from(ctx.querySelectorAll(sel))}
function debounce(fn,wait=150){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait)}}
function hasAttr(el,name){return el&&el.hasAttribute&&el.hasAttribute(name)}
function getText(el){return el?(el.textContent||'').trim():''}
function preventDragStart(e){e.preventDefault()}
function visHide(el){Object.assign(el.style,{position:'absolute',width:'1px',height:'1px',padding:'0',margin:'-1px',overflow:'hidden',clip:'rect(0,0,0,0)',whiteSpace:'nowrap',border:'0'})}
function shouldUseSearch(native){const ds=(native.getAttribute('data-search')||'').toLowerCase();return native.hasAttribute('search')||ds==='1'||ds==='true'}
function normalizeText(s){return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()}
function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function mapNormSpanToOrig(label,normStart,normLen){const chars=Array.from(label);let acc=0,start=0,end=chars.length;for(let i=0;i<chars.length;i++){const n=normalizeText(chars[i]);if(acc<=normStart&&(acc+n.length)>normStart)start=i;if(acc<normStart+normLen&&(acc+n.length)>=normStart+normLen){end=i+1;break}
acc+=n.length}
return[start,end,chars]}
function highlightLabel(label,q){if(!q)return escapeHTML(label);const normLabel=normalizeText(label);const normQ=normalizeText(q);const idx=normLabel.indexOf(normQ);if(idx<0)return escapeHTML(label);const[start,end,chars]=mapNormSpanToOrig(label,idx,normQ.length);const before=escapeHTML(chars.slice(0,start).join(''));const middle=escapeHTML(chars.slice(start,end).join(''));const after=escapeHTML(chars.slice(end).join(''));return `${before}<mark class="mrr-hl">${middle}</mark>${after}`}
function measureTextWidth(containerEl,text){const probe=document.createElement('span');Object.assign(probe.style,{visibility:'hidden',position:'absolute',whiteSpace:'nowrap',pointerEvents:'none',left:'-9999px'});probe.textContent=text;const cs=getComputedStyle(containerEl);['fontFamily','fontSize','fontWeight','fontStyle','letterSpacing','textTransform','textIndent','textRendering','textDecoration','wordSpacing','lineHeight'].forEach(p=>probe.style[p]=cs[p]);document.body.appendChild(probe);const w=probe.getBoundingClientRect().width;probe.remove();return w}
function getAvailableLabelWidth(dd,selectedEl){const input=dd.querySelector('.mrr-input');if(!input){const w=selectedEl.getBoundingClientRect().width||0;return w}
const cs=getComputedStyle(input);let available=input.getBoundingClientRect().width-((parseFloat(cs.paddingLeft)||0)+(parseFloat(cs.paddingRight)||0));const icon=dd.querySelector('.icon-down');if(icon){const iconW=icon.getBoundingClientRect().width||0;const ics=getComputedStyle(icon);available-=iconW+((parseFloat(ics.marginLeft)||0)+(parseFloat(ics.marginRight)||0))}
return Math.max(0,available-8)}
function buildFittedText(selectedEl,labels,dd){const available=getAvailableLabelWidth(dd,selectedEl);if(!Number.isFinite(available)||available<=0){return{text:labels.join(', '),hidden:Math.max(0,labels.length-1)}}
const shown=[];let text='';for(let i=0;i<labels.length;i++){const candidate=shown.length?`${text}, ${labels[i]}`:labels[i];const remaining=labels.length-(i+1);const suffix=remaining>0?` (+${remaining})`:'';if(measureTextWidth(selectedEl,candidate+suffix)<=available){shown.push(labels[i]);text=candidate}else break}
const hidden=labels.length-shown.length;if(hidden>0)text=(shown.join(', ')||'')+(shown.length?` (+${hidden})`:`(+${hidden})`);return{text,hidden}}
function isOpen(dd){return dd.classList.contains('is-open')}
function isAnimating(dd){return dd.classList.contains('is-animating')}
function isMultiple(dd){return hasAttr(dd,'multiple')}
function getAllItems(dd){return $$('.mrr-content-dropdown .item',dd)}
function getSelectedItems(dd){return getAllItems(dd).filter(i=>i.classList.contains('ativo'))}
function getItemValue(item){if(!item||typeof item.getAttribute!=='function')return null;if(item.hasAttribute('value')){const v=item.getAttribute('value');return v.trim()===''?null:v}
const span=item.querySelector('span');return getText(span)||getText(item)||null}
function labelsFromItems(items){return items.map(i=>getText(i.querySelector('span'))||getText(i)).filter(Boolean)}
function setDataValor(dd,values){dd.setAttribute('data-valor',values.join(','))}
function openDropdown(dd){if(isOpen(dd)||isAnimating(dd)||dd.classList.contains('is-disabled'))return;const content=dd.querySelector('.mrr-content-dropdown');if(!content)return;dd.classList.add('is-animating','is-opening');content.classList.remove('hidden');content.addEventListener('animationend',function handler(e){if(e.target!==content)return;content.removeEventListener('animationend',handler);dd.classList.remove('is-animating','is-opening');dd.classList.add('is-open')},{once:!0})}
function closeDropdown(dd){if(!isOpen(dd)||isAnimating(dd))return;const content=dd.querySelector('.mrr-content-dropdown');if(!content)return;dd.classList.add('is-animating','is-closing');content.addEventListener('animationend',function handler(e){if(e.target!==content)return;content.removeEventListener('animationend',handler);dd.classList.remove('is-animating','is-closing','is-open');content.classList.add('hidden')},{once:!0})}
function toggleDropdown(dd){return isOpen(dd)?closeDropdown(dd):openDropdown(dd)}
function computeSelectionData(dd){const items=getSelectedItems(dd);const labels=labelsFromItems(items);const values=items.map(getItemValue).filter(v=>v!=null);return{items,labels,values}}
function updateSelectedVisual(dd){const sel=dd.querySelector('.valor-selected');if(!sel)return;const original=sel.dataset.originalPlaceholder||sel.textContent||'Selecione';const{labels,values}=computeSelectionData(dd);if(!isMultiple(dd)){if(labels.length){sel.classList.remove('placeholder');sel.textContent=labels[0]}else{sel.classList.add('placeholder');sel.textContent=original}}else{if(!labels.length){sel.classList.add('placeholder');sel.textContent=original}else{sel.classList.remove('placeholder');sel.textContent=buildFittedText(sel,labels,dd).text}}
setDataValor(dd,values);if(!dd.__fromNative){syncSelectFromDropdown(dd,values)}
dispatchChange(dd)}
function setActiveByValues(dd,values){const S=new Set(values.map(v=>String(v).trim()).filter(Boolean));getAllItems(dd).forEach(item=>{const val=item.getAttribute('value');const label=getText(item.querySelector('span'))||getText(item);const match=(val!=null&&S.has(val))||S.has(label);item.classList[match?'add':'remove']('ativo')})}
function dispatchChange(dd){const{labels,values}=computeSelectionData(dd);dd.dispatchEvent(new CustomEvent('mrr:change',{bubbles:!0,detail:{dropdown:dd,dataId:dd.getAttribute('data-id')||null,multiple:isMultiple(dd),labels,values}}))}
function onItemClick(dd,item){if(item.classList.contains('is-disabled'))return;if(isMultiple(dd)){item.classList.toggle('ativo');updateSelectedVisual(dd)}else{getAllItems(dd).forEach(i=>i.classList.remove('ativo'));item.classList.add('ativo');updateSelectedVisual(dd);closeDropdown(dd)}}
function handleDocClick(e){$$('.mrr-dropdown.is-open').forEach(dd=>{const inp=dd.querySelector('.mrr-input');const cnt=dd.querySelector('.mrr-content-dropdown');if(!(inp&&inp.contains(e.target))&&!(cnt&&cnt.contains(e.target))){closeDropdown(dd)}})}
function handleKeydown(e){if(e.key==='Escape')$$('.mrr-dropdown.is-open').forEach(closeDropdown);}
const onResize=debounce(()=>{$$('.mrr-dropdown[multiple]').forEach(updateSelectedVisual)},150);function bindSearch(dd){const input=dd.querySelector('.mrr-search-input');const list=dd.querySelector('.mrr-list')||dd.querySelector('.mrr-content-dropdown');if(!input||!list)return;function applyFilter(){const q=input.value.trim();const nq=normalizeText(q);const items=$$('.item',list);items.forEach(it=>{const sp=it.querySelector('span');const base=sp?.dataset?.orig||getText(sp);const norm=it.dataset.norm||normalizeText(base);const hit=nq===''||norm.includes(nq);it.classList.toggle('is-hidden',!hit);if(sp)sp.innerHTML=hit?highlightLabel(base,q):escapeHTML(base);});$$('.mrr-group',list).forEach(g=>{const anyVisible=$$('.item',g).some(it=>!it.classList.contains('is-hidden'));g.style.display=anyVisible?'':'none'})}
input.addEventListener('input',applyFilter);input.addEventListener('keyup',applyFilter);const content=dd.querySelector('.mrr-content-dropdown');if(content){content.addEventListener('animationend',()=>{if(!isOpen(dd)&&input.value){input.value='';applyFilter()}})}}
function syncSelectFromDropdown(dd,values){const native=dd.__nativeSelect;if(!native)return;native.__mrrSyncing=!0;const S=new Set(values.map(String));Array.from(native.options).forEach(opt=>{opt.selected=S.has(opt.value)||(S.size===0&&opt.value===''&&!native.multiple)});native.dispatchEvent(new Event('change',{bubbles:!0}))}
function syncDropdownFromSelect(native){const dd=native.__mrrDropdown;if(!dd)return;dd.__fromNative=!0;const values=Array.from(native.selectedOptions).map(o=>o.value);setActiveByValues(dd,values);updateSelectedVisual(dd);if(native.disabled)dd.classList.add('is-disabled');else dd.classList.remove('is-disabled');dd.__fromNative=!1}
function createItem(opt){const item=document.createElement('div');item.className='item';if(opt.disabled)item.classList.add('is-disabled');if(opt.value!=null&&String(opt.value).trim()!=='')item.setAttribute('value',opt.value);if(opt.selected)item.classList.add('ativo');const t=document.createElement('span');t.textContent=opt.textContent;t.dataset.orig=t.textContent;item.appendChild(t);item.dataset.label=t.textContent;item.dataset.norm=normalizeText(t.textContent);return item}
function buildListFromNative(native){const frag=document.createDocumentFragment();const list=document.createElement('div');list.className='mrr-list';const children=Array.from(native.children);children.forEach(node=>{if(node.tagName==='OPTGROUP'){const g=document.createElement('div');g.className='mrr-group';if(node.disabled)g.classList.add('is-disabled');const glabel=document.createElement('div');glabel.className='mrr-group-label';glabel.textContent=node.label||'';const gitems=document.createElement('div');gitems.className='mrr-group-items';Array.from(node.children).forEach(opt=>{const item=createItem(opt);if(node.disabled)item.classList.add('is-disabled');gitems.appendChild(item)});g.appendChild(glabel);g.appendChild(gitems);list.appendChild(g)}else if(node.tagName==='OPTION'){list.appendChild(createItem(node))}});frag.appendChild(list);return frag}
function buildDropdownFromSelect(native){const dd=document.createElement('div');dd.className='mrr-dropdown';dd.setAttribute('role','listbox');dd.dataset.id=native.id||native.name||'';if(native.multiple)dd.setAttribute('multiple','');if(native.disabled)dd.classList.add('is-disabled');const input=document.createElement('div');input.className='mrr-input';const span=document.createElement('span');span.className='valor-selected placeholder';const placeholder=native.getAttribute('data-placeholder')??native.querySelector('option[value=""]')?.textContent?.trim()??'Selecione';span.textContent=placeholder;const icon=document.createElement('div');icon.className='icon-down';icon.textContent='▾';input.appendChild(span);input.appendChild(icon);const content=document.createElement('div');content.className='mrr-content-dropdown hidden';if(shouldUseSearch(native)){const s=document.createElement('div');s.className='mrr-search';const si=document.createElement('input');si.type='text';si.name=native.getAttribute('data-search-name')||`mrr-search-${dd.dataset.id || 'anon'}`;si.autocomplete='off';si.className='mrr-search-input';si.placeholder=native.getAttribute('data-search-placeholder')||'Pesquisar...';s.appendChild(si);content.appendChild(s)}
content.appendChild(buildListFromNative(native));dd.appendChild(input);dd.appendChild(content);dd.__nativeSelect=native;native.__mrrDropdown=dd;bindOneDropdown(dd);if(shouldUseSearch(native))bindSearch(dd);return dd}
window.mrr_selected_dropdown=function(id,rawValue){const dd=document.querySelector(`.mrr-dropdown[data-id="${id}"]`);if(!dd)return;const values=Array.isArray(rawValue)?rawValue:String(rawValue||'').split(',').map(s=>s.trim()).filter(Boolean);dd.setAttribute('data-valor',values.join(','));setActiveByValues(dd,values);updateSelectedVisual(dd)};window.mrr_render_itens=function(id,items){const dd=document.querySelector(`.mrr-dropdown[data-id="${id}"]`);if(!dd)return;const content=dd.querySelector('.mrr-content-dropdown');if(!content)return;let list=content.querySelector('.mrr-list');if(!list){list=document.createElement('div');list.className='mrr-list';content.appendChild(list)}
list.innerHTML='';(items||[]).forEach(o=>{if(o&&Array.isArray(o.items)){const g=document.createElement('div');g.className='mrr-group';if(o.disabled)g.classList.add('is-disabled');const gl=document.createElement('div');gl.className='mrr-group-label';gl.textContent=o.label||'';const gi=document.createElement('div');gi.className='mrr-group-items';(o.items||[]).forEach(it=>{const div=document.createElement('div');div.className='item';if(o.disabled||it.disabled)div.classList.add('is-disabled');if(it.value!=null&&String(it.value).trim()!=='')div.setAttribute('value',it.value);const span=document.createElement('span');span.textContent=String(it.label||'');span.dataset.orig=span.textContent;div.appendChild(span);div.dataset.label=span.textContent;div.dataset.norm=normalizeText(span.textContent);gi.appendChild(div)});g.appendChild(gl);g.appendChild(gi);list.appendChild(g)}else{const div=document.createElement('div');div.className='item';if(o.disabled)div.classList.add('is-disabled');if(o.value!=null&&String(o.value).trim()!=='')div.setAttribute('value',o.value);const span=document.createElement('span');span.textContent=String(o.label||'');span.dataset.orig=span.textContent;div.appendChild(span);div.dataset.label=span.textContent;div.dataset.norm=normalizeText(span.textContent);list.appendChild(div)}});updateSelectedVisual(dd)};window.mrr_get_selected_values=function(id){const dd=document.querySelector(`.mrr-dropdown[data-id="${id}"]`);if(!dd)return[];return getSelectedItems(dd).map(getItemValue).filter(v=>v!=null)};window.mrr_get_selected_labels=function(id){const dd=document.querySelector(`.mrr-dropdown[data-id="${id}"]`);if(!dd)return[];return getSelectedItems(dd).map(i=>getText(i.querySelector('span'))||getText(i)).filter(Boolean)};window.mrr_open_dropdown=function(id){const dd=document.querySelector(`.mrr-dropdown[data-id="${id}"]`);if(dd&&!isOpen(dd))openDropdown(dd);};window.mrr_close_dropdown=function(id){const dd=document.querySelector(`.mrr-dropdown[data-id="${id}"]`);if(dd&&isOpen(dd))closeDropdown(dd);};window.mrr_toggle_dropdown=function(id){const dd=document.querySelector(`.mrr-dropdown[data-id="${id}"]`);if(dd)toggleDropdown(dd);};window.mrr_clear_dropdown=function(id){const dd=document.querySelector(`.mrr-dropdown[data-id="${id}"]`);if(!dd)return;dd.setAttribute('data-valor','');getAllItems(dd).forEach(i=>i.classList.remove('ativo'));updateSelectedVisual(dd)};function bindOneDropdown(dd){if(dd.dataset.mrrInit==='1')return;dd.dataset.mrrInit='1';const selLbl=dd.querySelector('.valor-selected');if(selLbl)selLbl.dataset.originalPlaceholder=selLbl.textContent;const inp=dd.querySelector('.mrr-input');const cnt=dd.querySelector('.mrr-content-dropdown');if(!inp||!cnt)return;inp.addEventListener('click',e=>{e.preventDefault();e.stopPropagation();toggleDropdown(dd)});cnt.addEventListener('click',e=>{const item=e.target.closest('.item');if(!item||!cnt.contains(item))return;e.preventDefault();onItemClick(dd,item)});if('ResizeObserver' in window&&isMultiple(dd)){new ResizeObserver(()=>updateSelectedVisual(dd)).observe(inp)}
const raw=(dd.getAttribute('data-valor')||'').trim();const values=raw?raw.split(',').map(v=>v.trim()).filter(Boolean):[];setActiveByValues(dd,values);updateSelectedVisual(dd)}
function initMrrDropdownsFromSelects(){document.addEventListener('dragstart',e=>{const t=e.target;if(t&&(t.tagName==='A'||t.tagName==='IMG'))preventDragStart(e);},{passive:!1});$$('select.mrr-dropdown').forEach(native=>{if(native.__mrrDropdown)return;const dd=buildDropdownFromSelect(native);native.parentNode.insertBefore(dd,native.nextSibling);visHide(native);native.addEventListener('change',()=>{if(native.__mrrSyncing){native.__mrrSyncing=!1;return}
syncDropdownFromSelect(native)});syncDropdownFromSelect(native)});document.addEventListener('click',handleDocClick);document.addEventListener('keydown',handleKeydown);window.addEventListener('resize',onResize)}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initMrrDropdownsFromSelects,{once:!0})}else{initMrrDropdownsFromSelects()}